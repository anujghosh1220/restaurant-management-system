{% extends "base.html" %}

{% block title %}Secure Payment - Restaurant Management System{% endblock %}

{% block extra_css %}
<style>
    .payment-option {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    .payment-option:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .payment-option input[type="radio"] {
        display: none;
    }
    .payment-option label {
        display: block;
        padding: 16px;
        cursor: pointer;
        margin: 0;
        background: #fff;
    }
    .payment-option input[type="radio"]:checked + label {
        background-color: #f5f9ff;
        border-left: 4px solid #2d8cf0;
    }
    .payment-method-icon {
        width: 40px;
        height: 40px;
        background: #f5f5f5;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        color: #666;
    }
    .payment-method-details {
        flex: 1;
    }
    .payment-method-title {
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
    }
    .payment-method-desc {
        font-size: 13px;
        color: #666;
    }
    .payment-method-extra {
        font-size: 12px;
        color: #2d8cf0;
        margin-top: 4px;
    }
    .saved-cards {
        margin-top: 8px;
        padding-left: 20px;
        border-left: 2px solid #eee;
    }
    .saved-card {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f5f5f5;
    }
    .saved-card:last-child {
        border-bottom: none;
    }
    .card-logo {
        width: 32px;
        margin-right: 12px;
    }
    .card-details span {
        display: block;
        font-size: 13px;
    }
    .card-number {
        font-weight: 500;
    }
    .card-name {
        color: #666;
        font-size: 12px !important;
    }
    .add-new-payment {
        color: #2d8cf0;
        font-weight: 500;
        cursor: pointer;
        margin-top: 8px;
        display: inline-block;
    }
    .payment-form {
        padding: 16px;
        background: #f9f9f9;
        border-radius: 8px;
        margin-top: 12px;
        display: none;
    }
    .payment-form.active {
        display: block;
    }
    .order-summary {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 16px;
        margin-top: 24px;
    }
    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
    }
    .summary-total {
        font-weight: 600;
        font-size: 16px;
        border-top: 1px solid #eee;
        padding-top: 12px;
        margin-top: 8px;
    }
    .payment-method-image {
        height: 24px;
        margin-right: 8px;
        vertical-align: middle;
    }
    .payment-option-header {
        display: flex;
        align-items: center;
    }
    .payment-option-content {
        margin-top: 12px;
        display: none;
    }
    .payment-option input[type="radio"]:checked ~ .payment-option-content {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <!-- Payment Options -->
        <div class="col-lg-8">
            <div class="mb-4">
                <a href="{{ url_for('view_cart') }}" class="text-decoration-none">
                    <i class="fas fa-arrow-left me-2"></i> Back to Cart
                </a>
                <h4 class="mt-3 mb-4">Select Payment Method</h4>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Payment Form -->
                    <form id="payment-form">
                        <!-- Cash on Delivery -->
                        <div class="payment-option">
                            <input type="radio" name="paymentMethod" id="cod" value="cod" checked>
                            <label for="cod">
                                <div class="payment-option-header">
                                    <div class="payment-method-icon">
                                        <i class="fas fa-money-bill-wave"></i>
                                    </div>
                                    <div class="payment-method-details">
                                        <div class="payment-method-title">Cash on Delivery</div>
                                        <div class="payment-method-desc">Choose your preferred payment method</div>
                                    </div>
                                </div>
                            </label>
                            <div class="payment-option-content">
                                <div class="payment-form" id="cod-form">
                                    <div class="mb-3">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="cod_payment_method" id="cod_upi" value="upi" checked>
                                            <label class="form-check-label" for="cod_upi">
                                                <strong>Pay via UPI</strong>
                                                <div class="text-muted small">Scan and pay using any UPI app when your order arrives</div>
                                            </label>
                                        </div>
                                        
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="radio" name="cod_payment_method" id="cod_cash" value="cash">
                                            <label class="form-check-label" for="cod_cash">
                                                <strong>Pay with Cash</strong>
                                                <div class="text-muted small">Pay with physical cash when your order arrives</div>
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        Please have the exact amount ready when the delivery partner arrives.
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="cod_terms" name="cod_terms" required>
                                        <label class="form-check-label" for="cod_terms">
                                            I understand that I need to pay the full amount when the order is delivered.
                                        </label>
                                        <div class="invalid-feedback">
                                            You must agree to the terms
                                        </div>
                                    </div>
                                    <!-- Hidden input for COD payment method -->
                                    <input type="hidden" name="cod_payment_method" id="cod_payment_method" value="upi">
                                </div>
                            </div>
                        </div>

                        <!-- Place Order Button -->
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg" id="place-order-btn">
                                <i class="fas fa-lock me-2"></i> Place Order & Pay (₹{{ "%.2f"|format(total) }})
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-body">
                    <h6 class="card-title mb-3">Add a Note (Optional)</h6>
                    <textarea class="form-control" rows="3" placeholder="Any special instructions for delivery partner?"></textarea>
                </div>
            </div>
        </div>
        
        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Order Summary</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        {% for item in cart_items %}
                        <div class="d-flex justify-content-between mb-2">
                            <div>
                                <span class="me-2">{{ item.quantity }}x</span>
                                <span>{{ item.menu_item.name }}</span>
                            </div>
                            <div>₹{{ "%.2f"|format(item.quantity * item.menu_item.price) }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <hr>
                    
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>Item Total</span>
                            <span>₹{{ "%.2f"|format(subtotal) }}</span>
                        </div>
                        {% if settings.discount_percentage > 0 %}
                        <div class="d-flex justify-content-between">
                            <span>Discount ({{ settings.discount_percentage }}%)</span>
                            <span class="text-success">-₹{{ "%.2f"|format(discount_amount) }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>After Discount</span>
                            <span>₹{{ "%.2f"|format(net_price) }}</span>
                        </div>
                        {% endif %}
                        <div class="d-flex justify-content-between">
                            <span>GST ({{ settings.gst_percentage }}%)</span>
                            <span>₹{{ "%.2f"|format(gst_amount) }}</span>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <h5>Total Amount</h5>
                        <h5>₹{{ "%.2f"|format(total) }}</h5>
                    </div>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-lock me-1"></i> Your payment information is secure
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Show/hide payment forms based on selection
    const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
    
    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            // Hide all payment forms
            document.querySelectorAll('.payment-form').forEach(form => {
                form.style.display = 'none';
            });
            
            // Show selected payment form
            const formId = this.value + '-form';
            const form = document.getElementById(formId);
            if (form) {
                form.style.display = 'block';
            }
        });
    });
    
    // Initialize first payment form as visible
    const firstPaymentRadio = document.querySelector('input[name="paymentMethod"]:checked');
    if (firstPaymentRadio) {
        const firstFormId = firstPaymentRadio.value + '-form';
        const firstForm = document.getElementById(firstFormId);
        if (firstForm) {
            firstForm.style.display = 'block';
        }
    }
    
    // Handle place order button click
    const placeOrderBtn = document.getElementById('place-order-btn');
    const paymentForm = document.getElementById('payment-form');
    
    if (paymentForm) {
        paymentForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked');
            
            // Reset validation
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            // Validate based on selected payment method
            let isValid = true;
            
            if (selectedMethod.value === 'upi') {
                const upiId = document.getElementById('upi_id');
                if (!upiId.value.trim() || !/^[a-zA-Z0-9._-]+@[a-zA-Z0-9]+$/.test(upiId.value)) {
                    upiId.classList.add('is-invalid');
                    isValid = false;
                }
            } 
            else if (selectedMethod.value === 'card') {
                const cardNumber = document.getElementById('card_number');
                const cardExpiry = document.getElementById('card_expiry');
                const cardCvv = document.getElementById('card_cvv');
                const cardName = document.getElementById('card_name');
                
                // Simple validation
                if (!cardNumber.value.trim() || !/^\d{12,19}$/.test(cardNumber.value.replace(/\s+/g, ''))) {
                    cardNumber.classList.add('is-invalid');
                    isValid = false;
                }
                if (!cardExpiry.value.trim() || !/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(cardExpiry.value)) {
                    cardExpiry.classList.add('is-invalid');
                    isValid = false;
                }
                if (!cardCvv.value.trim() || !/^\d{3,4}$/.test(cardCvv.value)) {
                    cardCvv.classList.add('is-invalid');
                    isValid = false;
                }
                if (!cardName.value.trim()) {
                    cardName.classList.add('is-invalid');
                    isValid = false;
                }
            }
            else if (selectedMethod.value === 'netbanking') {
                const bank = document.getElementById('bank');
                if (!bank.value) {
                    bank.classList.add('is-invalid');
                    isValid = false;
                }
            }
            
            if (!isValid) {
                // Scroll to first error
                const firstInvalid = document.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }
            
            if (!selectedMethod) {
                showAlert('Please select a payment method', 'danger');
                return;
            }
            
            // Collect payment details
            const paymentDetails = {};
            const formData = new FormData(this);
            
            // Get the selected COD payment method if COD is selected
            if (selectedMethod.value === 'cod') {
                const codMethod = document.querySelector('input[name="cod_payment_method"]:checked');
                if (codMethod) {
                    paymentDetails.cod_payment_method = codMethod.value;
                    document.getElementById('cod_payment_method').value = codMethod.value;
                }
            }
            
            // Get all form data
            for (let [key, value] of formData.entries()) {
                if (key.startsWith(selectedMethod.value + '_')) {
                    const cleanKey = key.replace(selectedMethod.value + '_', '');
                    paymentDetails[cleanKey] = value;
                }
            }
            
            // Validate required fields based on payment method
            if (selectedMethod.value === 'upi' && !paymentDetails.upi_id) {
                showAlert('Please enter UPI ID', 'danger');
                return;
            }
            
            if (selectedMethod.value === 'card') {
                if (!paymentDetails.card_number || !paymentDetails.expiry || !paymentDetails.cvv || !paymentDetails.name) {
                    showAlert('Please fill in all card details', 'danger');
                    return;
                }
                
                // Basic card validation
                const cardNumber = paymentDetails.card_number.replace(/\s+/g, '');
                if (!/^\d{13,19}$/.test(cardNumber)) {
                    showAlert('Please enter a valid card number', 'danger');
                    return;
                }
                
                if (!/^\d{3,4}$/.test(paymentDetails.cvv)) {
                    showAlert('Please enter a valid CVV', 'danger');
                    return;
                }
                
                // Format expiry date to MM/YY
                const [month, year] = paymentDetails.expiry.split('/');
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear() % 100;
                const currentMonth = currentDate.getMonth() + 1;
                
                if (parseInt(month) < 1 || parseInt(month) > 12) {
                    showAlert('Please enter a valid expiry month (01-12)', 'danger');
                    return;
                }
                
                if (parseInt(year) < currentYear || (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
                    showAlert('Card has expired', 'danger');
                    return;
                }
            }
            
            // Show loading state
            const originalText = placeOrderBtn.innerHTML;
            placeOrderBtn.disabled = true;
            placeOrderBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
            
            try {
                // Make API call to process payment
                const response = await fetch('/api/process-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        payment_method: selectedMethod.value,
                        payment_details: paymentDetails
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    showAlert(result.message, 'success');
                    
                    // Redirect to order confirmation page after a short delay
                    setTimeout(() => {
                        window.location.href = `/order-confirmation?order_id=${result.order_id}`;
                    }, 1500);
                } else {
                    showAlert(result.message || 'Payment failed. Please try again.', 'danger');
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Payment error:', error);
                showAlert('An error occurred while processing your payment. Please try again.', 'danger');
                placeOrderBtn.disabled = false;
                placeOrderBtn.innerHTML = originalText;
            }
        });
    }
    
    // Auto-format card number
    const cardNumberInput = document.getElementById('card_number');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
            e.target.value = value.trim();
        });
    }
    
    // Auto-format expiry date
    const expiryDateInput = document.getElementById('card_expiry');
    if (expiryDateInput) {
        expiryDateInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
    }
    
    // Helper function to show alerts
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.role = 'alert';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        const container = document.querySelector('.container.my-4');
        if (container) {
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-remove alert after 5 seconds
            setTimeout(() => {
                const alert = bootstrap.Alert.getOrCreateInstance(alertDiv);
                if (alert) alert.close();
            }, 5000);
        }
    }
    
    // Handle UPI ID validation
    const upiIdInput = document.getElementById('upi_id');
    if (upiIdInput) {
        upiIdInput.addEventListener('input', function(e) {
            const upiPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9]+$/;
            const isValid = upiPattern.test(e.target.value) || e.target.value === '';
            
            const feedback = document.getElementById('upi-feedback');
            if (feedback) {
                if (!isValid && e.target.value) {
                    feedback.textContent = 'Please enter a valid UPI ID (e.g., example@upi)';
                    feedback.style.display = 'block';
                } else {
                    feedback.style.display = 'none';
                }
            }
        });
    }
});
</script>
{% endblock %}
